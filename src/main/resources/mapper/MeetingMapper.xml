<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTO Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="sshj.sshj.mapper.MeetingMapper">
    <insert id="insertMeeting" parameterType="sshj.sshj.dto.MeetingDto">
        <![CDATA[
			INSERT INTO tb_meeting(
				meeting_name,
				deadline,
				start_date,
				end_date,
				category,
				explanation_title,
				explanation_content,
				created_time,
				max_participant,
				club_id)
			VALUES(
				#{meetingName},
				#{deadline},
				#{startDate},
				#{endDate},
				#{category},
				#{explanationTitle},
				#{explanationContent},
				now(),
				#{maxParticipant},
				#{clubId})
		]]>
    </insert>

    <select id="selectMeeting" parameterType="long" resultType="sshj.sshj.dto.MeetingDto">
        <![CDATA[
			SELECT
				meeting_id as meetingId,
				meeting_name as meetingName,
				deadline as deadline,
				start_date as startDate,
				end_date as endDate,
				category as category,
				explanation_title as explanationTitle,
				explanation_content as explanationContent,
				created_time as createdTime,
				max_participant as maxParticipant,
				club_id as clubId
			FROM
				tb_meeting
			WHERE
			    meeting_id=#{meetingId}
		]]>
    </select>

    <select id="selectMeetingList" resultType="sshj.sshj.dto.MeetingDto">
        <![CDATA[
			SELECT
				tbm.meeting_id as meetingId,
				tbm.meeting_name as meetingName,
				tbm.deadline as deadline,
				tbm.start_date as startDate,
				tbm.end_date as endDate,
				tbm.category as category,
				tbm.explanation_title as explanationTitle,
				tbm.explanation_content as explanationContent,
				tbm.created_time as createdTime,
				tbm.max_participant as maxParticipant,
				(SELECT COUNT(*) FROM tb_user_by_meeting tubm WHERE tbm.meeting_id = tubm.meeting_id) as curParticipant,
				tbm.meeting_place as meetingPlace,
				tbu.nickname as clubName,
				tbm.club_id as clubId
			FROM
				tb_meeting as tbm
			JOIN
				tb_user as tbu
			ON
				tbm.club_id = tbu.user_id;
		]]>
    </select>

    <select id="selectClubByMeetingList" parameterType="long" resultType="sshj.sshj.dto.MeetingDto">
        <![CDATA[
			SELECT
				meeting_id as meetingId,
				meeting_name as meetingName,
				deadline as deadline,
				start_date as startDate,
				end_date as endDate,
				category as category,
				explanation_title as explanationTitle,
				explanation_content as explanationContent,
				created_time as createdTime,
				max_participant as maxParticipant,
				club_id as clubId
			FROM
				tb_meeting
			WHERE
			    club_id=#{clubId}
		]]>
    </select>

    <update id="updateMeeting" parameterType="sshj.sshj.dto.MeetingDto">
        <![CDATA[
			UPDATE tb_meeting
			SET meeting_name=#{meetingName},
				deadline=#{deadline},
				start_date=#{startDate},
				end_date=#{endDate},
				category=#{category},
				explanation_title=#{explanationTitle},
				explanation_content=#{explanationContent},
				created_time=now(),
				max_participant=#{maxParticipant}
			WHERE meeting_id=#{meetingId}
		]]>
    </update>

    <delete id="deleteMeeting" parameterType="long">
        <![CDATA[
            DELETE FROM tb_meeting
            WHERE meeting_id=#{meetingId}
        ]]>
    </delete>

    <select id="selectUserByMeetingList" resultType="sshj.sshj.dto.MeetingDto">
        <![CDATA[
			SELECT
				meeting_id as meetingId,
				meeting_name as meetingName,
				deadline as deadline,
				start_date as startDate,
				end_date as endDate,
				category as category,
				explanation_title as explanationTitle,
				explanation_content as explanationContent,
				created_time as createdTime,
				max_participant as maxParticipant,
				club_id as clubId
			FROM
				tb_meeting
			WHERE
			    meeting_id IN (SELECT meeting_id FROM tb_user_by_meeting WHERE user_id = #{userId})
		]]>
    </select>

    <insert id="insertMeetingLike">
        <![CDATA[
        INSERT INTO tb_meeting_like(
            user_id,
            meeting_id)
        VALUES(
        #{userId},
        #{meetingId})
        ]]>
    </insert>

    <delete id="deleteMeetingLike">
        <![CDATA[
            DELETE FROM tb_meeting_like
            WHERE user_id=#{userId} AND meeting_id=#{meetingId}
        ]]>
    </delete>
</mapper>